# Calculate path=~/.dconfigure.d chmod=700 ini(update.dconf)!=off
#!/bin/bash

dconf_append(){
	echo "# dconf_append $@" >&2
	local KEY="$1"
	shift

	local orig_value="$(dconf read "${KEY}")"
	if [ -n "${orig_value}" -a \( "${orig_value#[}" = "${orig_value}" -o "${orig_value%]}" = "${orig_value}" \) ]; then
		echo "${KEY} is not list parameter or does not exist" >&2
		return 1
	fi
	dconf write "${KEY}" "$(
		(
			echo "${orig_value}"| sed -re 's/^\[|\]$//g' -e 's/, /\n/g'
			for v in "$@"; do
				if  [ "${v#\'}" != "${v}" -a "${v%\'}" != "${v}" -o "${v#\"}" != "${v}" -a "${v%\"}" != "${v}" ]; then
					echo " $v"
				else
					echo " '${v}'"
				fi
			done )| sort| uniq| grep -Ev '^\s*$'| \
		awk '{if(1==FNR)printf "[%s", $0; else printf ", %s", $0} END{printf "]";}'
	)"
}

dconf_remove(){
	echo "# dconf_remove $@"
	local KEY="$1"
	local deleting_elements= v= o=
	shift
	for v in "$@" ; do
		if  [ "${v#\'}" != "${v}" -a "${v%\'}" != "${v}" -o "${v#\"}" != "${v}" -a "${v%\"}" != "${v}" ]; then
			deleting_elements[$((1+ ${#deleting_elements[@]}))]=${v}
		else
			deleting_elements[$((1+ ${#deleting_elements[@]}))]="'${v}'"
		fi
	done
	dconf write "${KEY}" "$(
		for o in $(dconf read "${KEY}" | sed -e 's/, /\n/g' -nre 's/^\[(.*)\]$/\1/gp'); do
			for v in "${deleting_elements[@]}"; do 
				[ "$v" = "$o" ] && o= && break
			done
			[ -n "$o" ] && echo "$o"
		done| \
		awk '{if(1==FNR)printf "[%s", $0; else printf ", %s", $0} END{printf "]";}'
	)"
}

echo "### Reset background background picture ..." >&2
dconf reset -f /org/mate/desktop/background/

echo "### Reset panels ..." >&2
#dconf reset -f /org/mate/panel/ 
mate-panel --reset

sleep .5

echo "### Set the desktop environment ..." >&2
dconf write /org/mate/desktop/media-handling/automount-open false
#?pkg(media-fonts/droid)!=#
dconf write /org/mate/caja/desktop/font "'Droid Sans 12'"
dconf write /org/mate/desktop/interface/font-name "'Droid Sans 12'"
dconf write /org/mate/desktop/interface/document-font-name "'Droid Sans 12'"
dconf write /org/mate/desktop/interface/monospace-font-name "'Droid Sans Mono Slashed 12'"
dconf write /org/mate/marco/general/titlebar-font "'Droid Sans Bold 12'"
#pkg#
#?pkg(x11-themes/calculate-xcursors)!=#
dconf write /org/mate/desktop/interface/cursor-theme "'calculate'"
#pkg#
#?pkg(x11-themes/calculate-icon-theme)!=#
dconf write /org/mate/desktop/interface/icon-theme "'Calculate'"
#pkg#
#?pkg(media-gfx/calculate-wallpapers)!=#
dconf write /org/mate/desktop/background/show-desktop-icons true
dconf write /org/mate/desktop/background/picture-filename "'/usr/share/wallpapers/Calculate_Linux/contents/images/#-os_x11_standart-#.jpg'"
dconf write /org/mate/desktop/background/picture-options "'stretched'"
#pkg#

echo "### Set the screensaver environment ..." >&2
dconf write /org/mate/settings-daemon/plugins/media-keys/screensaver "'Scroll_Lock'"
#?os_root_type==livecd#
dconf write /org/mate/screensaver/lock-enabled false
#os_root_type#
#?os_root_type!=livecd#
dconf write /org/mate/screensaver/lock-enabled true
#os_root_type#
#?pkg(mate-extra/mate-screensaver)!=&&pkg(app-accessibility/onboard)!=#
dconf write /org/mate/screensaver/embedded-keyboard-enabled true
dconf write /org/mate/screensaver/embedded-keyboard-command "'/usr/bin/onboard --xid'"
#pkg#


## COnfigure panels

## panels
echo "### Create the 'calculate main panel' ..." >&2
dconf write /org/mate/panel/toplevels/calculate_main_panel/size 32
dconf write /org/mate/panel/toplevels/calculate_main_panel/orientation "'top'"
dconf write /org/mate/panel/toplevels/calculate_main_panel/expand true
dconf write /org/mate/panel/general/toplevel-id-list "['calculate_main_panel']"

echo "### Add applets to the 'calculate main panel' ..." >&2
## objects on calculate_main_panel
dconf write /org/mate/panel/objects/calculate_main_panel_0000_mainmenu/toplevel-id "'calculate_main_panel'"
dconf write /org/mate/panel/objects/calculate_main_panel_0000_mainmenu/position 0
dconf write /org/mate/panel/objects/calculate_main_panel_0000_mainmenu/object-type "'menu'"
dconf write /org/mate/panel/objects/calculate_main_panel_0000_mainmenu/tooltip "'Main Menu'"
dconf write /org/mate/panel/objects/calculate_main_panel_0000_mainmenu/locked true
dconf_append /org/mate/panel/general/object-id-list calculate_main_panel_0000_mainmenu

dconf write /org/mate/panel/objects/calculate_main_panel_0010_Home/toplevel-id "'calculate_main_panel'"
dconf write /org/mate/panel/objects/calculate_main_panel_0010_Home/position 10
dconf write /org/mate/panel/objects/calculate_main_panel_0010_Home/object-type "'launcher'"
dconf write /org/mate/panel/objects/calculate_main_panel_0010_Home/launcher-location "'Home.desktop'"
dconf write /org/mate/panel/objects/calculate_main_panel_0010_Home/locked true
dconf_append /org/mate/panel/general/object-id-list calculate_main_panel_0010_home

dconf write /org/mate/panel/objects/calculate_main_panel_0020_Share/toplevel-id "'calculate_main_panel'"
dconf write /org/mate/panel/objects/calculate_main_panel_0020_Share/position 20
dconf write /org/mate/panel/objects/calculate_main_panel_0020_Share/object-type "'launcher'"
dconf write /org/mate/panel/objects/calculate_main_panel_0020_Share/launcher-location "'Share.desktop'"
dconf write /org/mate/panel/objects/calculate_main_panel_0020_Share/locked true
dconf_append /org/mate/panel/general/object-id-list calculate_main_panel_0020_Share

dconf write /org/mate/panel/objects/calculate_main_panel_0030_FTP/toplevel-id "'calculate_main_panel'"
dconf write /org/mate/panel/objects/calculate_main_panel_0030_FTP/position 20
dconf write /org/mate/panel/objects/calculate_main_panel_0030_FTP/object-type "'launcher'"
dconf write /org/mate/panel/objects/calculate_main_panel_0030_FTP/launcher-location "'FTP.desktop'"
dconf write /org/mate/panel/objects/calculate_main_panel_0030_FTP/locked true
dconf_append /org/mate/panel/general/object-id-list calculate_main_panel_0030_FTP

dconf write /org/mate/panel/objects/calculate_main_panel_0040_workspace-switcher/toplevel-id "'calculate_main_panel'"
dconf write /org/mate/panel/objects/calculate_main_panel_0040_workspace-switcher/position 40
dconf write /org/mate/panel/objects/calculate_main_panel_0040_workspace-switcher/object-type "'applet'"
dconf write /org/mate/panel/objects/calculate_main_panel_0040_workspace-switcher/applet-iid "'WnckletFactory::WorkspaceSwitcherApplet'"
dconf write /org/mate/panel/objects/calculate_main_panel_0040_workspace-switcher/locked true
dconf write /org/mate/panel/objects/calculate_main_panel_0040_workspace-switcher/prefs/display-all-workspaces true
dconf write /org/mate/panel/objects/calculate_main_panel_0040_workspace-switcher/prefs/num-rows 1
dconf_append /org/mate/panel/general/object-id-list calculate_main_panel_0040_workspace-switcher

dconf write /org/mate/panel/objects/calculate_main_panel_0050_show-desktop/toplevel-id "'calculate_main_panel'"
dconf write /org/mate/panel/objects/calculate_main_panel_0050_show-desktop/position 50
dconf write /org/mate/panel/objects/calculate_main_panel_0050_show-desktop/object-type "'applet'"
dconf write /org/mate/panel/objects/calculate_main_panel_0050_show-desktop/applet-iid "'WnckletFactory::ShowDesktopApplet'"
dconf write /org/mate/panel/objects/calculate_main_panel_0050_show-desktop/locked true
dconf_append /org/mate/panel/general/object-id-list calculate_main_panel_0050_show-desktop

dconf write /org/mate/panel/objects/calculate_main_panel_0060_window-list/toplevel-id "'calculate_main_panel'"
dconf write /org/mate/panel/objects/calculate_main_panel_0060_window-list/position 60
dconf write /org/mate/panel/objects/calculate_main_panel_0060_window-list/object-type "'applet'"
dconf write /org/mate/panel/objects/calculate_main_panel_0060_window-list/applet-iid "'WnckletFactory::WindowListApplet'"
dconf write /org/mate/panel/objects/calculate_main_panel_0060_window-list/locked true
dconf_append /org/mate/panel/general/object-id-list calculate_main_panel_0060_window-list

dconf write /org/mate/panel/objects/calculate_main_panel_9960_notification-area/toplevel-id "'calculate_main_panel'"
dconf write /org/mate/panel/objects/calculate_main_panel_9960_notification-area/position 9960
dconf write /org/mate/panel/objects/calculate_main_panel_9960_notification-area/object-type "'applet'"
dconf write /org/mate/panel/objects/calculate_main_panel_9960_notification-area/applet-iid "'NotificationAreaAppletFactory::NotificationArea'"
dconf write /org/mate/panel/objects/calculate_main_panel_9960_notification-area/locked true
dconf_append /org/mate/panel/general/object-id-list calculate_main_panel_9960_notification-area

dconf write /org/mate/panel/objects/calculate_main_panel_9970_clock/toplevel-id "'calculate_main_panel'"
dconf write /org/mate/panel/objects/calculate_main_panel_9970_clock/position 9970
dconf write /org/mate/panel/objects/calculate_main_panel_9970_clock/object-type "'applet'"
dconf write /org/mate/panel/objects/calculate_main_panel_9970_clock/applet-iid "'ClockAppletFactory::ClockApplet'"
dconf write /org/mate/panel/objects/calculate_main_panel_9970_clock/locked true
dconf write /org/mate/panel/objects/calculate_main_panel_9970_clock/prefs/format "'24-hour'"
dconf write /org/mate/panel/objects/calculate_main_panel_9970_clock/prefs/speed-unit "'m/s'"
dconf write /org/mate/panel/objects/calculate_main_panel_9970_clock/prefs/temperature-unit "'Centigrade'"
dconf write /org/mate/panel/objects/calculate_main_panel_9970_clock/prefs/custom-format "''"
dconf_append /org/mate/panel/general/object-id-list calculate_main_panel_9970_clock

dconf write /org/mate/panel/objects/calculate_main_panel_9980_lock/toplevel-id "'calculate_main_panel'"
#dconf write /org/mate/panel/objects/calculate_main_panel_9980_lock/panel-right-stick true
#dconf write /org/mate/panel/objects/calculate_main_panel_9980_lock/position 20
dconf write /org/mate/panel/objects/calculate_main_panel_9980_lock/position 9980
dconf write /org/mate/panel/objects/calculate_main_panel_9980_lock/object-type "'action'"
dconf write /org/mate/panel/objects/calculate_main_panel_9980_lock/action-type "'lock'"
dconf write /org/mate/panel/objects/calculate_main_panel_9980_lock/locked true
dconf_append /org/mate/panel/general/object-id-list calculate_main_panel_9980_lock

dconf write /org/mate/panel/objects/calculate_main_panel_9990_logout/toplevel-id "'calculate_main_panel'"
#dconf write /org/mate/panel/objects/calculate_main_panel_9990_logout/panel-right-stick true
#dconf write /org/mate/panel/objects/calculate_main_panel_9990_logout/position 10
dconf write /org/mate/panel/objects/calculate_main_panel_9990_logout/position 9990
dconf write /org/mate/panel/objects/calculate_main_panel_9990_logout/object-type "'action'"
dconf write /org/mate/panel/objects/calculate_main_panel_9990_logout/action-type "'logout'"
dconf write /org/mate/panel/objects/calculate_main_panel_9990_logout/locked true
dconf_append /org/mate/panel/general/object-id-list calculate_main_panel_9990_logout


## objects on calculate_bottom_panel

echo "### Create the 'calculate bottom panel' ..." >&2
dconf write /org/mate/panel/toplevels/calculate_bottom_panel/size 48
dconf write /org/mate/panel/toplevels/calculate_bottom_panel/orientation "'bottom'"
dconf write /org/mate/panel/toplevels/calculate_bottom_panel/expand false
dconf write /org/mate/panel/toplevels/calculate_bottom_panel/auto-hide true
dconf write /org/mate/panel/toplevels/calculate_bottom_panel/x 0
dconf write /org/mate/panel/toplevels/calculate_bottom_panel/x-centered true
dconf write /org/mate/panel/toplevels/calculate_bottom_panel/y 0
dconf write /org/mate/panel/toplevels/calculate_bottom_panel/y-bottom 0
dconf write /org/mate/panel/general/toplevel-id-list "['calculate_main_panel', 'calculate_bottom_panel']"


echo "### Add applets to the 'calculate bottom panel' ..." >&2
#for d in $(echo /usr/share/applications/calculate-*.desktop| sed -nre 's:/usr/share/applications/calculate-(\S+).desktop:\1:gp'); do
for d in browser mail chat im writer calc calculator imageedit imageview audioplayer videoplayer imageburn textedit terminal; do
	dconf write "/org/mate/panel/objects/calculate_bottom_panel__${d}/toplevel-id" "'calculate_bottom_panel'"
	dconf write "/org/mate/panel/objects/calculate_bottom_panel__${d}/object-type" "'launcher'"
	dconf write "/org/mate/panel/objects/calculate_bottom_panel__${d}/launcher-location" "'calculate-${d}.desktop'"
	dconf write "/org/mate/panel/objects/calculate_bottom_panel__${d}/locked" true
	dconf_append /org/mate/panel/general/object-id-list calculate_bottom_panel__${d}
done

#?ini(main.mavriq_fixes)==on#
echo "### Change size of 'calculate main panel' ..." >&2
dconf write /org/mate/panel/toplevels/calculate_main_panel/size 23
dconf write /org/mate/panel/toplevels/calculate_main_panel/background/type "'color'"
dconf write /org/mate/panel/toplevels/calculate_main_panel/background/color "'#ffffff'"
dconf write /org/mate/panel/toplevels/calculate_main_panel/background/opacity 12000

echo "### Create the 'second top panel' ..." >&2
dconf write /org/mate/panel/toplevels/second_top_panel/size 21
dconf write /org/mate/panel/toplevels/second_top_panel/orientation "'top'"
dconf write /org/mate/panel/toplevels/second_top_panel/expand true
dconf write /org/mate/panel/toplevels/second_top_panel/background/type "'color'"
dconf write /org/mate/panel/toplevels/second_top_panel/background/color "'#ffffff'"
dconf write /org/mate/panel/toplevels/second_top_panel/background/opacity 12000
dconf_append /org/mate/panel/general/toplevel-id-list 'second_top_panel'

echo "### Add applets to the 'calculate main panel' ..." >&2
dconf write /org/mate/panel/objects/second_top_panel_0000_winmenu/toplevel-id "'second_top_panel'"
dconf write /org/mate/panel/objects/second_top_panel_0000_winmenu/position 0
dconf write /org/mate/panel/objects/second_top_panel_0000_winmenu/object-type "'applet'"
dconf write /org/mate/panel/objects/second_top_panel_0000_winmenu/applet-iid "'WnckletFactory::WindowMenuApplet'"
dconf_append /org/mate/panel/general/object-id-list second_top_panel_0000_winmenu

dconf write /org/mate/panel/objects/second_top_panel_0010_window-list/toplevel-id "'second_top_panel'"
dconf write /org/mate/panel/objects/second_top_panel_0010_window-list/position 10
dconf write /org/mate/panel/objects/second_top_panel_0010_window-list/object-type "'applet'"
dconf write /org/mate/panel/objects/second_top_panel_0010_window-list/applet-iid "'WnckletFactory::WindowListApplet'"
dconf write /org/mate/panel/objects/second_top_panel_0010_window-list/locked true
dconf_append /org/mate/panel/general/object-id-list second_top_panel_0010_window-list

dconf_remove /org/mate/panel/general/object-id-list calculate_main_panel_0060_window-list

dconf write /org/mate/marco/general/num-workspaces 8

#dconf write /org/mate/panel/objects/calculate_main_panel_0060_sensors/applet-iid "'SensorsAppletFactory::SensorsApplet'"
#dconf write /org/mate/panel/objects/calculate_main_panel_0060_sensors/toplevel-id "'calculate_main_panel'"
#dconf write /org/mate/panel/objects/calculate_main_panel_0060_sensors/position 60
#dconf write /org/mate/panel/objects/calculate_main_panel_0060_sensors/object-type "'applet'"
#dconf write /org/mate/panel/objects/calculate_main_panel_0060_sensors/panel-right-stick false
# TODO: отключать все ненужные сенсоры, оставлять лишь один-два
#dconf_append /org/mate/panel/general/object-id-list calculate_main_panel_0060_sensors

dconf write /org/mate/panel/objects/calculate_main_panel_0070_inhibit/applet-iid "'InhibitAppletFactory::InhibitApplet'"
dconf write /org/mate/panel/objects/calculate_main_panel_0070_inhibit/toplevel-id "'calculate_main_panel'"
dconf write /org/mate/panel/objects/calculate_main_panel_0070_inhibit/position 70
dconf write /org/mate/panel/objects/calculate_main_panel_0070_inhibit/object-type "'applet'"
dconf write /org/mate/panel/objects/calculate_main_panel_0070_inhibit/panel-right-stick false
dconf_append /org/mate/panel/general/object-id-list calculate_main_panel_0070_inhibit
#ini#
